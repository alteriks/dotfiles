#!/bin/bash

set -eo pipefail

RED='\033[0;31m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color
echo -e ${RED}$SHELL${NC}

{% if yadm.hostname == "carbon" %}
CLASS=laptop
OS_TYPE=arch
{% else %}
CLASS=other
{% endif %}
{% if yadm.hostname == "moar" %}
CLASS=workstation
OS_TYPE=arch
{% endif %}
{% if yadm.hostname == "nebula" %}
CLASS=server
OS_TYPE=arch
{% endif %}
{% if yadm.hostname == "lordjim" %}
CLASS=rpi
OS_TYPE=debian
{% endif %}

HOSTNAME=$(hostname)

yadm config local.class $CLASS
echo -e "${GREEN}[+] yadm class:${NC}" $(yadm config local.class)
echo ""

if [[ -e /bin/zsh && $SHELL != /bin/zsh ]]; then
  echo 
  echo -e "${GREEN}[+] Change shell${NC}"
  echo 
  chsh -s /bin/zsh
  echo ""
fi


echo -e "${GREEN}[+] Update yadm submodule${NC}"
cd $HOME
yadm submodule init
yadm submodule update

# ZSH History file location, we don't have XDG envs yet
mkdir -p ~/.local/share/zsh

if [[ $CLASS != other ]]; then
  echo 
  echo -e "${GREEN}[+] Installing packages (pacman)${NC}"
  echo 
  sudo ~/bin/yadm/${OS_TYPE}/root_pre.sh

  echo 
  echo -e "${GREEN}[+] Installing packages (yay)${NC}"
  echo 
  cp ~/bin/yadm/${OS_TYPE}/user.sh /tmp
  sudo -u '#1000' /tmp/user.sh
  rm -f /tmp/user.sh

  echo 
  echo -e "${GREEN}[+] PostInstall as root${NC}"
  echo 
  sudo ~/bin/yadm/${OS_TYPE}/root_post.sh
  echo ""
fi

# Because Git submodule commands cannot operate without a work tree, they must
# be run from within $HOME (assuming this is the root of your dotfiles)
cd "$HOME"

echo -e "${GREEN}[+] Init submodules${NC}"
yadm submodule update --recursive --init
echo ""

if [[ $CLASS != rpi && $CLASS != other && $EUID -ge 1000 ]]; then
  echo -e "${GREEN}[+] Updating the yadm repo origin URL${NC}"
  yadm remote set-url origin "git@github.com:alteriks/dotfiles.git"
  echo ""
fi

if command -v nvim >/dev/null 2>&1; then
  echo -e "${GREEN}[+] Bootstraping neovim"
  nvim '+PlugUpdate' '+PlugClean!' '+PlugUpdate' '+qall'
  echo ""
fi

if [[ -e ~/.config/tmux/plugins/tpm/bin/install_plugins ]]; then
  echo -e "${GREEN}[+] Automatic tpm installation${NC}"
  ~/.config/tmux/plugins/tpm/bin/install_plugins
  echo ""
fi

if [[ $CLASS != other ]]; then
  echo -e "${GREEN}Mkdir${NC}"
  mkdir -p $HOME/git
  mkdir -p $HOME/tmp

  source ~/.profile
  mkdir -p "$XDG_CACHE_HOME"/zsh
  mkdir -p "$XDG_DATA_HOME"/zsh
  mkdir -p "$XDG_CACHE_HOME"/nvim
  mkdir -p "$XDG_DATA_HOME"/wineprefixes
fi

if [[ $CLASS != other && $EUID -ge 1000 ]]; then
  echo
  #TODO: from list git clone/pull
fi
